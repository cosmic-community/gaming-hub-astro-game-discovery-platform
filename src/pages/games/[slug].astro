// src/pages/games/[slug].astro
---
import Layout from '../../layouts/Layout.astro'
import Header from '../../components/Header.astro'
import Footer from '../../components/Footer.astro'
import CosmicBadge from '../../components/CosmicBadge.astro'
import { getGameBySlug, getGamesByGenre, getAllGames } from '../../lib/cosmic'
import type { Game } from '../../../types'

// Get the slug from the URL parameters
export interface Props {
  slug: string
}

const { slug } = Astro.params as { slug: string }

// Fetch the game data
const game = await getGameBySlug(slug)

if (!game) {
  return Astro.redirect('/404')
}

// Fetch related games if the game has a genre
let relatedGames: Game[] = []
if (game.metadata?.genre) {
  try {
    const allRelatedGames = await getGamesByGenre(game.metadata.genre.id)
    // Filter out the current game and limit to 3 related games
    relatedGames = allRelatedGames
      .filter(relatedGame => relatedGame.id !== game.id)
      .slice(0, 3)
  } catch (error) {
    console.error('Failed to fetch related games:', error)
    relatedGames = []
  }
}

// Get bucket slug for the Cosmic badge
const bucketSlug = import.meta.env.COSMIC_BUCKET_SLUG || 'your-bucket'

// Helper functions
const formatDate = (dateString: string): string => {
  try {
    const date = new Date(dateString)
    return date.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    })
  } catch {
    return dateString
  }
}

const cleanDescription = (html: string): string => {
  return html.replace(/<[^>]*>/g, '')
}

// Generate static paths for all games
export async function getStaticPaths() {
  try {
    const games = await getAllGames()
    return games.map((game) => ({
      params: { slug: game.slug },
    }))
  } catch (error) {
    console.error('Failed to generate static paths:', error)
    return []
  }
}
---

<Layout 
  title={`${game.metadata?.game_title || game.title} - Gaming Hub`}
  description={cleanDescription(game.metadata?.description || '')}
>
  <Header />
  
  <main>
    <!-- Game Hero Section -->
    <section class="relative py-16 bg-gradient-to-r from-gaming-darker to-gaming-dark">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
          <!-- Game Info -->
          <div class="order-2 lg:order-1">
            <!-- Genre Badge -->
            {game.metadata?.genre && (
              <div class="inline-flex items-center mb-4">
                <span 
                  class="px-3 py-1 rounded-full text-sm font-medium text-white"
                  style={`background-color: ${game.metadata.genre.metadata?.genre_color || '#4444ff'}`}
                >
                  {game.metadata.genre.metadata?.genre_name || game.metadata.genre.title}
                </span>
              </div>
            )}

            <!-- Rating Badge -->
            {game.metadata?.rating && (
              <div class="inline-flex items-center mb-4 ml-3">
                <span class="px-3 py-1 bg-gray-700 text-white rounded text-sm font-medium">
                  {game.metadata.rating.value}
                </span>
              </div>
            )}

            <!-- Featured Badge -->
            {game.metadata?.featured_game && (
              <div class="inline-flex items-center mb-6">
                <svg class="w-5 h-5 text-yellow-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
                <span class="text-yellow-400 font-medium">Featured Game</span>
              </div>
            )}
            
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-6">
              {game.metadata?.game_title || game.title}
            </h1>
            
            <!-- Description -->
            <div class="text-gray-300 text-lg leading-relaxed mb-8">
              <div set:html={game.metadata?.description} />
            </div>
            
            <!-- Game Details -->
            <div class="space-y-4">
              <!-- Developer -->
              {game.metadata?.developer && (
                <div class="flex items-center text-gray-400">
                  <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span class="mr-2">Developer:</span>
                  <a 
                    href={`/developers/${game.metadata.developer.slug}`}
                    class="text-primary-400 hover:text-primary-300 transition-colors font-medium"
                  >
                    {game.metadata.developer.metadata?.studio_name || game.metadata.developer.title}
                  </a>
                </div>
              )}
              
              <!-- Release Date -->
              {game.metadata?.release_date && (
                <div class="flex items-center text-gray-400">
                  <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                  </svg>
                  <span class="mr-2">Released:</span>
                  <span>
                    {formatDate(game.metadata.release_date)}
                  </span>
                </div>
              )}
              
              <!-- Platforms -->
              {game.metadata?.platform && game.metadata.platform.length > 0 && (
                <div class="flex items-center text-gray-400">
                  <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2h-2.22l.123.489.804.804A1 1 0 0113 18H7a1 1 0 01-.707-1.707l.804-.804L7.22 15H5a2 2 0 01-2-2V5zm5.771 7H5V5h10v7H8.771z" clip-rule="evenodd" />
                  </svg>
                  <span class="mr-3">Platforms:</span>
                  <div class="flex flex-wrap gap-2">
                    {game.metadata.platform.map((platform: string) => (
                      <span class="bg-gray-800 text-white px-2 py-1 rounded text-sm">
                        {platform}
                      </span>
                    ))}
                  </div>
                </div>
              )}
            </div>
            
            <!-- Developer Website Link -->
            {game.metadata?.developer?.metadata?.website && (
              <div class="mt-8">
                <a 
                  href={game.metadata.developer.metadata.website}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center bg-primary-500 hover:bg-primary-600 text-white px-6 py-3 rounded-lg font-medium transition-colors"
                >
                  Visit Developer
                  <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                  </svg>
                </a>
              </div>
            )}
          </div>
          
          <!-- Featured Image -->
          <div class="order-1 lg:order-2">
            {game.metadata?.featured_image ? (
              <img 
                src={`${game.metadata.featured_image.imgix_url}?w=800&h=600&fit=crop&auto=format,compress`}
                alt={game.metadata.game_title || game.title}
                class="w-full rounded-lg shadow-xl"
                loading="eager"
                width="800"
                height="600"
              />
            ) : (
              <div class="w-full h-96 bg-gradient-to-br from-gaming-accent to-primary-500 rounded-lg flex items-center justify-center">
                <div class="text-center text-white">
                  <svg class="w-24 h-24 mx-auto mb-4 opacity-50" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />
                  </svg>
                  <p class="text-xl font-medium">{game.metadata?.game_title || game.title}</p>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </section>

    <!-- Screenshots Section -->
    {game.metadata?.screenshots && game.metadata.screenshots.length > 0 && (
      <section class="py-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <h2 class="text-3xl font-bold text-white mb-8">Screenshots</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {game.metadata.screenshots.map((screenshot: any, index: number) => (
              <img 
                src={`${screenshot.imgix_url}?w=600&h=400&fit=crop&auto=format,compress`}
                alt={`${game.metadata.game_title || game.title} screenshot ${index + 1}`}
                class="w-full h-64 object-cover rounded-lg shadow-lg hover:shadow-xl transition-shadow"
                loading="lazy"
                width="600"
                height="400"
              />
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- Related Games Section -->
    {relatedGames.length > 0 && (
      <section class="py-16 bg-gaming-dark">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex items-center justify-between mb-8">
            <h2 class="text-3xl font-bold text-white">
              More {game.metadata?.genre?.metadata?.genre_name || 'Similar'} Games
            </h2>
            {game.metadata?.genre && (
              <a 
                href={`/genres/${game.metadata.genre.slug}`}
                class="text-primary-400 hover:text-primary-300 font-medium transition-colors"
              >
                View All {game.metadata.genre.metadata?.genre_name || game.metadata.genre.title} Games →
              </a>
            )}
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {relatedGames.map((relatedGame: Game) => (
              <article class="bg-gaming-darker rounded-lg overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1">
                <div class="relative">
                  {relatedGame.metadata?.featured_image ? (
                    <img 
                      src={`${relatedGame.metadata.featured_image.imgix_url}?w=600&h=300&fit=crop&auto=format,compress`}
                      alt={relatedGame.metadata.game_title || relatedGame.title}
                      class="w-full h-48 object-cover"
                      loading="lazy"
                      width="600"
                      height="300"
                    />
                  ) : (
                    <div class="w-full h-48 bg-gradient-to-br from-gaming-accent to-primary-500 flex items-center justify-center">
                      <span class="text-white text-2xl font-bold">
                        {(relatedGame.metadata?.game_title || relatedGame.title).charAt(0)}
                      </span>
                    </div>
                  )}
                  
                  {relatedGame.metadata?.rating && (
                    <div class="absolute top-3 right-3">
                      <span class="px-2 py-1 bg-black bg-opacity-70 text-white text-xs rounded">
                        {relatedGame.metadata.rating.value}
                      </span>
                    </div>
                  )}
                </div>
                
                <div class="p-6">
                  <h3 class="text-xl font-bold text-white mb-3">
                    <a href={`/games/${relatedGame.slug}`} class="hover:text-primary-400 transition-colors">
                      {relatedGame.metadata?.game_title || relatedGame.title}
                    </a>
                  </h3>
                  
                  {relatedGame.metadata?.description && (
                    <p class="text-gray-400 text-sm leading-relaxed mb-4 line-clamp-3">
                      {cleanDescription(relatedGame.metadata.description)}
                    </p>
                  )}
                  
                  <div class="flex items-center justify-between">
                    {relatedGame.metadata?.developer && (
                      <span class="text-xs text-gray-500">
                        {relatedGame.metadata.developer.metadata?.studio_name || relatedGame.metadata.developer.title}
                      </span>
                    )}
                    
                    <a 
                      href={`/games/${relatedGame.slug}`}
                      class="text-primary-400 hover:text-primary-300 text-sm font-medium transition-colors"
                    >
                      Learn More →
                    </a>
                  </div>
                </div>
              </article>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- Instagram Redirect Section -->
    <section class="py-16 bg-gradient-to-r from-purple-900 to-pink-800">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-2xl p-8">
          <div class="flex justify-center mb-6">
            <svg class="w-16 h-16 text-pink-300" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
            </svg>
          </div>
          <h2 class="text-3xl font-bold text-white mb-4">
            Follow Our Gaming Journey
          </h2>
          <p class="text-pink-100 text-lg mb-8 max-w-2xl mx-auto">
            Get the latest gaming updates, behind-the-scenes content, and exclusive previews on our Instagram!
          </p>
          <a 
            href="https://instagram.com/doubtfxll"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white px-8 py-4 rounded-full font-bold text-lg transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl"
          >
            <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
            </svg>
            Follow @doubtfxll
          </a>
          <p class="text-pink-200 text-sm mt-4">
            Join thousands of gaming enthusiasts already following us!
          </p>
        </div>
      </div>
    </section>
  </main>
  
  <Footer />
  <CosmicBadge bucketSlug={bucketSlug} />
</Layout>